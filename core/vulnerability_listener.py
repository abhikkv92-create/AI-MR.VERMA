import hashlib
import logging
import os
import threading
import time

log = logging.getLogger("Kernel.Security")


class VulnerabilityListener:
    """
    Real-time security monitor for the MR.VERMA codebase.
    Tracks file hashes of sensitive directories and triggers
    the SecurityArchitect cluster upon detection of mutations.
    """

    def __init__(self, watch_paths=None):
        self.watch_paths = watch_paths or ["core", "agents", "scripts", ".env"]
        self.file_registry = {}
        self._stop_event = threading.Event()
        self._monitor_thread = None
        self.last_incident = None

    def start(self):
        """Build initial registry and start monitor."""
        self._build_registry()
        self._monitor_thread = threading.Thread(target=self._monitor_loop, daemon=True)
        self._monitor_thread.start()
        log.info(f"VulnerabilityListener ACTIVE: Watching {self.watch_paths}")

    def _get_file_hash(self, filepath):
        try:
            with open(filepath, "rb") as f:
                return hashlib.sha256(f.read()).hexdigest()
        except Exception:
            return None

    def _build_registry(self):
        for path in self.watch_paths:
            full_path = os.path.join(os.getcwd(), path)
            if os.path.isfile(full_path):
                self.file_registry[full_path] = self._get_file_hash(full_path)
            elif os.path.isdir(full_path):
                for root, _, files in os.walk(full_path):
                    for file in files:
                        f_path = os.path.join(root, file)
                        self.file_registry[f_path] = self._get_file_hash(f_path)

    def _monitor_loop(self):
        while not self._stop_event.is_set():
            for filepath, old_hash in list(self.file_registry.items()):
                new_hash = self._get_file_hash(filepath)
                if new_hash and new_hash != old_hash:
                    log.warning(f"SECURITY ALERT: Mutation detected in {filepath}")
                    self.file_registry[filepath] = new_hash
                    self.last_incident = {
                        "type": "MUTATION",
                        "file": filepath,
                        "timestamp": time.time(),
                    }
                    # Here we would trigger the SecurityArchitect.scan(filepath)

            # Check for new files
            self._scan_for_new_files()
            time.sleep(5)

    def _scan_for_new_files(self):
        # Simplified: checking root directory and core for new arrivals
        for path in self.watch_paths:
            full_path = os.path.join(os.getcwd(), path)
            if os.path.isdir(full_path):
                for root, _, files in os.walk(full_path):
                    for file in files:
                        f_path = os.path.join(root, file)
                        if f_path not in self.file_registry:
                            log.warning(
                                f"SECURITY ALERT: New file detected in secure zone: {f_path}"
                            )
                            self.file_registry[f_path] = self._get_file_hash(f_path)
                            self.last_incident = {
                                "type": "NEW_FILE",
                                "file": f_path,
                                "timestamp": time.time(),
                            }

    def get_status(self):
        return {
            "watched_files": len(self.file_registry),
            "last_incident": self.last_incident,
            "status": "SECURE" if not self.last_incident else "AUDITING",
        }


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    v = VulnerabilityListener()
    v.start()
    while True:
        time.sleep(10)
